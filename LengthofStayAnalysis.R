## Sets up environment
library(tidyverse)
library(readr)
library(readxl)
library(ggplot2)
library(dplyr)
library(tidyr)

## Imports dataset
lengthOfStay <- read_excel("~/Documents/LengthOfStay.xlsx")
glimpse(lengthOfStay)

## Creates statistical mode function
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

## Finds average and median length of stay
Summary_Los <- lengthOfStay %>% 
  summarize(
    Avg_Los <- mean(Length_Of_Stay), #Average
    Median_Los <- median(Length_Of_Stay), #Median
    Mode_Los <- Mode(Length_Of_Stay), #Mode
    Sd_Los <- sd(Length_Of_Stay) #Standard deviation
  )

## Orders months in Admission Month column
all(lengthOfStay$Admission_Month %in% month.name)
lengthOfStay$Admission_Month <- factor(lengthOfStay$Admission_Month, levels=month.name)

## plots LOS distribution by admission month
ggplot(lengthOfStay, aes(x = Admission_Month, y = Length_Of_Stay)) + 
  geom_boxplot(fill = "#66c2a5",
               alpha = 0.7,
               outlier.color = "#fc8d62",
               outlier.alpha = 0.3,
               outlier.size = 0.8 ) +
  labs(title = "Length of Stay Distribution by Admission Month",
       subtitle = "Median stay = 4 days across all monts",
       x = "Admission Month", y = "Length of Stay (Days)",
       caption = "Based on 100,000+ admissions | Box shows IQR (25th-75th percentile)") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(color = "gray40", size = 11)) +
  scale_y_continuous(breaks = seq(0,18,2)) + ## Customizes the y axis
  coord_cartesian(ylim = c(0, 18)) ## zooms in in on the y axis

## verifies if weekend admissions are longer, the same or less. 
ggplot(lengthOfStay, aes(x = factor(Day_of_Week, 
                                    levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
                         y = Length_Of_Stay)) + 
  geom_bar(stat = "summary", fun = "mean", fill = "#66c2a5") + 
  labs(title = "Length of Stay by Admission Day",
       x = "Day of Week", y = "Length of Stay") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) 

## Which condition affects length of stay
Conditions_Vs_Los <- lengthOfStay %>% 
  select(Dialysis_Renal_End_Stage_Flag, Asthma_Flag, ##Selects all flags
         Iron_Deficiency_Flag, pneumonia_Flag, 
         Substance_Dependence_Flag, Major_Psychological_Disorder_Flag,
         Depression_Flag, Psychological_Disorder_Flag,
         Fibrosis_Flag, Malnutrition_Flag, 
         Blood_Disorder_Flag, Length_Of_Stay) %>% 
  pivot_longer(cols = -Length_Of_Stay, 
               names_to = "Condition", ## column for conditions/flags 
               values_to = "Present") %>% ## column for binary codes
  group_by(Condition, Present) %>% 
  summarize(Avg_Los = mean(Length_Of_Stay), .groups = "drop") %>% 
  pivot_wider(names_from = Present, values_from = Avg_Los) %>% 
  mutate(Impact = `1` - `0`) %>% 
  arrange(desc(Impact))
print(Conditions_Vs_Los)

## Lab values vs los
ggplot(lengthOfStay, aes(x = Avg_Glucose_Value, y = Length_Of_Stay)) +
  geom_point() +
  geom_smooth(method = "lm", color = "#66c2a5") +
  labs(title = "Glucose Levels Vs Length of Stay",
       x = "Glucose Value", 
       y = "Length of Stay") + 
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
  
# Risk Score
lengthOfStay <- lengthOfStay %>% 
  mutate(Risk_Score = 
           (Dialysis_Renal_End_Stage_Flag * 2.14) +
           (Fibrosis_Flag * 2.12) + 
           (Psychological_Disorder_Flag * 2.09) +
           (Malnutrition_Flag * 1.90) + 
           (Blood_Disorder_Flag * 1.89) +
           (pneumonia_Flag * 1.64) +
           (Major_Psychological_Disorder_Flag * 1.59) +
           (Iron_Deficiency_Flag * 1.56) +
           (Substance_Dependence_Flag * 1.44) + 
           (Depression_Flag * 1.29) +
           (Asthma_Flag * 1.05),
         
        Risk_Category = case_when(
          Risk_Score >= 4 ~ "High Risk",
          Risk_Score >= 2 ~ "Medium Risk",
          TRUE ~ "Low Risk"
        )
      )

#validates risk score
validation <- lengthOfStay %>% 
  group_by(Risk_Category) %>%  
  summarize(
    Avg_LOS = mean(Length_Of_Stay),
    Patient_Count = n (),
    min_LOS = min(Length_Of_Stay),
    max_LOS = max(Length_Of_Stay)
  )
print(validation)

## Plots Risk Categories
ggplot(lengthOfStay, aes(x = factor(Risk_Category,
                        levels = c("Low Risk", "Medium Risk", "High Risk")),
                        y = Length_Of_Stay, fill = Risk_Category)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Low Risk" = "#8da0cb",
                               "Medium Risk" = "#66c2a5",
                               "High Risk" = "#fc8d62")) +
  labs(title = "Length of Stay by Risk Category",
       subtitle = "High Risk Patients stay 2.3 days longer than Low Risk Patients",
       x = "", y = "Days") +
  theme_minimal() +
  theme(legend.position = "none")

#Calculates the risk ditributions among patients
risk_distribution <- lengthOfStay %>% 
  group_by(Risk_Category) %>% 
  summarize(Count = n()) %>% 
  mutate(Percentage = Count / sum(Count) * 100) 

#Plots distribution
ggplot(risk_distribution, aes(x = "", 
                              y = Count, 
                              fill = Risk_Category)) +
  geom_col(width = 1) +
  coord_polar("y") +
  scale_fill_manual(values = c("Low Risk" = "#8da0cb",
                               "Medium Risk" = "#66c2a5",
                               "High Risk" = "#fc8d62")) +
  labs(title = "Patient Distribution by Risk Category",
       subtitle = "79% of patients are Low Risk, 8% are High Risk") +
  theme_void() +
  theme(legend.position = "bottom")

#Business impact calculations
Impact_Calculation <- lengthOfStay %>% 
  group_by(Risk_Category) %>% 
  summarize(
    Avg_LOS = mean(Length_Of_Stay),
    Count = n()
  ) %>% 
  mutate(
    Potential_Savings_Days = ifelse(
      Risk_Category == "High Risk",
      Count * (Avg_LOS - 5.14),
      0
    )
  )

Total_Savings <- sum(Impact_Calculation$Potential_Savings_Days)
print(paste("Potential Bed Savings Per Day:",
            round(Total_Savings),
            "days"))

Cost_Savings <- Total_Savings * 3000
print(paste("Potential cost savings: $",
            format(Cost_Savings, big.mark = ",")))



  

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































